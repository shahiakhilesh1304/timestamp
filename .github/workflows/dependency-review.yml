# Dependency Review Workflow
# Checks PRs for dependency vulnerabilities and license compatibility
# Runs automatically on all pull requests to main branch
# Learn more: https://docs.github.com/en/code-security/supply-chain-security/understanding-your-software-supply-chain/about-dependency-review

name: Dependency Review

# Trigger on pull requests that modify dependencies
# Documentation: https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#pull_request
on:
  pull_request:
    branches: [ "main" ]

# Minimal permissions following principle of least privilege
# Learn more: https://docs.github.com/en/actions/security-for-github-actions/security-guides/automatic-token-authentication#permissions-for-the-github_token
permissions:
  contents: read
  pull-requests: write  # Required to comment on PRs with review results

# Allow concurrent runs on different PRs
# Cancel in-progress runs when new commits are pushed to the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      # Checkout code to analyze dependencies
      # Pinned to full commit SHA for security: https://docs.github.com/en/actions/security-for-github-actions/security-guides/security-hardening-for-github-actions
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # Run dependency review to check for vulnerabilities and license issues
      # This action analyzes dependency changes in the PR and fails if:
      # 1. Any dependency has known security vulnerabilities
      # 2. Any dependency uses a license incompatible with MIT
      # Learn more: https://github.com/actions/dependency-review-action
      - name: Review dependencies for vulnerabilities and license compatibility
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          # Fail on any vulnerability severity (critical, high, medium, low)
          # Adjust this to 'critical' or 'high' if you want to allow lower severity issues
          fail-on-severity: low

          # Allow only permissive licenses compatible with MIT
          # Uses allow-list instead of deprecated deny-list for better maintainability
          # See: https://github.com/actions/dependency-review-action/issues/997
          allow-licenses: MIT, ISC, Apache-2.0, BSD-2-Clause, BSD-3-Clause, 0BSD, CC0-1.0, Unlicense, Python-2.0

          # Comment on PR with review results (summary of vulnerabilities and license issues)
          comment-summary-in-pr: always

          # Configuration for vulnerability database
          # Use GitHub Advisory Database (most comprehensive for npm packages)
          vulnerability-check: true

          # Check both runtime and development dependencies
          # Development dependencies can also introduce supply chain risks
          fail-on-scopes: runtime, development
